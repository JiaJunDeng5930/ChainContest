# 合约文档使用指南

本目录存放由 `pnpm --filter contracts docs:generate` 自动生成的中文 NatSpec 文档。文件结构如下：

| 文件                   | 说明                                                                                   |
| ---------------------- | -------------------------------------------------------------------------------------- |
| `index.md`             | 合约索引页，汇总每个合约（或接口、库）的函数、事件、错误及数量统计，并跳转到对应段落。 |
| `<Contract>.md`        | 单个合约、接口或库的详细说明，按照函数 → 事件 → 错误顺序展开。                         |
| `libraries/*.md`       | 公共库函数文档，主要用于辅助合约实现。                                                 |
| `NatSpec 写作规范 .md` | 开发者撰写 NatSpec 时需遵循的中文规范、术语和示例。                                    |

> 建议从 `index.md` 起步，根据索引跳转到具体函数或事件的章节，避免在长文档中手动搜索。

## 审核者阅读路径

1. **确认合约范围**：在 `index.md` 的「总合约数」表中确认需要审阅的合约，并点击名称进入具体 Markdown 文档。
2. **锁定接口**：在合约文档中使用侧边目录（Markdown 解析器自动生成）或章节标题快速定位函数 / 事件 / 错误。
3. **比对源码**：每个章节关键词均与 Solidity 函数名一致，可在 `contracts/src` 中直接检索同名符号以核对实现。函数段落附带：
   - 功能概述与开发说明（中文）
   - 参数 / 返回值表格
   - 可能抛出的错误列表
   - 调用示例（用于理解业务流程）
4. **交叉校对链上行为**：
   - 文档顶部显示生成时的 `提交哈希` 与 `生成时间`，与部署记录比对以确保文档对应版本正确。
   - 若需验证事件 / 错误，表格中列出的参数顺序与 Solidity 定义一致，可直接映射到链上日志。
   - 对于资金流或权限校验函数，在「调用示例」段落中提供了推荐的复现步骤，可结合 Hardhat 本地环境执行。

## 术语表

| 术语           | 解释                                                                       |
| -------------- | -------------------------------------------------------------------------- |
| **报名资产**   | 参赛者参与比赛时需锁定的 ERC-20 代币，与 `ContestConfig.entryAsset` 对应。 |
| **Vault**      | 为每位参赛者部署的资产容器合约，负责承载报名资金与调仓逻辑。               |
| **冻结阶段**   | `Contest` 状态 `Frozen`，比赛停止交易并等待结算的阶段。                    |
| **密封阶段**   | `Contest` 状态 `Sealed`，用于领奖、退出与资产清算。                        |
| **TWAP**       | 时间加权平均价格（Time-Weighted Average Price），由 `PriceSource` 计算。   |
| **基点 (bps)** | 百分之一的百分之一，用于表示收益率或价格偏差，例如 `100 bps = 1%`。        |

更多术语及写作规范请参见 `NatSpec 写作规范 .md`。

## 校验与更新流程

1. 运行 `pnpm --filter contracts hardhat compile` 确保源码编译通过。
2. 执行 `pnpm --filter contracts docs:generate` 生成最新 Markdown 文件。
3. 如仅需校验覆盖率，可运行 `pnpm --filter contracts docs:check`，若缺失 NatSpec 或文档未更新会返回非零退出码。
4. 提交前确认 `git status` 干净，文档头部的提交哈希应与当前 `HEAD` 一致。

## 故障排查

| 场景                                         | 建议处理                                                                     |
| -------------------------------------------- | ---------------------------------------------------------------------------- |
| `docs:generate` 报告 `DocstringParsingError` | 检查对应 Solidity 函数的 NatSpec 标签是否缺失或参数名不匹配。                |
| 文档未生成新锚点                             | 确保函数 / 事件 / 错误的 NatSpec 中包含 `@notice`，并重新执行生成脚本。      |
| 索引链接跳转失败                             | 运行 `docs:generate` 重新生成索引，或检查 Markdown 渲染器是否支持 `#` 锚点。 |

如需在 CI 中集成，请根据 `docs/contracts/NatSpec 写作规范 .md` 中的“提交前自检”章节配置流水线。
